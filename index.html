<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>CodePen - #curiouslyminded</title>
  <link rel="stylesheet" href="./style.css">

</head>
<body>
<!-- partial:index.partial.html -->
<div id="shadercollab"></div>
<script id="vertex" type="x-shader/x-vertex">
    varying vec2 texCoordVarying;
      void main() {
          texCoordVarying = uv;
          gl_Position =   projectionMatrix *
                          modelViewMatrix *
                          vec4(position,1.0);
      }
</script>
<script id="frag" type="x-shader/x-vertex">
  varying vec2 texCoordVarying;
  uniform sampler2D webcam;
  uniform sampler2D backbuffer;
  uniform float time;
  uniform float resoluton;
  uniform vec2 resolution;
  const vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
  vec3 hsv2rgb(vec3 c) {
  vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
  return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
  }
  precision highp float;
    
  #define M_PI 3.1415926535897932384626433832795

  void main() {
  vec2 pixel = texCoordVarying; vec3 finalColor;
  vec3 webcamCapture = texture2D(webcam,pixel).rgb;
  vec3 lastFrame = texture2D(backbuffer,pixel).rgb;
  float step=.001;
  float dx = 1./resolution.x *step;
  float dy = 1./resolution.y *step;

  // OBJECTIVE: update pixel color, from information  of their neighburs from previous frame

  // 1. Get neighbourhood from prev buffer
  vec3 N = texture2D(backbuffer, vec2(pixel.x,pixel.y+dy)).rgb;
  vec3 S = texture2D(backbuffer, vec2(pixel.x,pixel.y-dy)).rgb;
  vec3 E = texture2D(backbuffer, vec2(pixel.x+dx,pixel.y)).rgb;
  vec3 W = texture2D(backbuffer, vec2(pixel.x-dx,pixel.y)).rgb;

  vec3 NE = texture2D(backbuffer, vec2(pixel.x+dx,pixel.y + dy)).rgb;
  vec3 NW = texture2D(backbuffer, vec2(pixel.x-dx,pixel.y + dy)).rgb;
  vec3 SE = texture2D(backbuffer, vec2(pixel.x+dx,pixel.y+dy)).rgb;
  vec3 SW = texture2D(backbuffer, vec2(pixel.x+dx,pixel.y-dy)).rgb;

  //2. DO something with neighbours
  //Rates of diffuson
  float diff1 = 1.1;
  float diff2 = 2.;
  float diff3 = 2.;
  float diff4 = -.1;

  vec3 new_color = lastFrame*2.;
  new_color += N * vec3(diff1, diff2, diff3);
  new_color += S * vec3(diff1, diff2, diff3);
  new_color += E * vec3(diff1, diff2, diff3);
  new_color += W * vec3(diff1, diff2, diff3);

  new_color += NE * diff4;
  new_color += SE * diff4;
  new_color += NW * diff4;
  new_color += SW * diff4;

  new_color /= 9.;

  new_color = hsv2rgb(new_color);


  float a = new_color.r;
  float del = webcamCapture.r*a*a*a +0.6-.2*a*a;
  new_color += del;

  new_color = clamp(new_color,0.,1.);

  finalColor = mix(lastFrame/new_color, webcamCapture , 0.47);
  gl_FragColor = vec4(finalColor,1.);
}
</script>
<!-- partial -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js'></script>
<script  src="script.js"></script>

</body>
</html>
